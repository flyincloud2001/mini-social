{% extends "layout.html" %}
{% set title = profile_user["username"] %}

{% block content %}
  <section class="card">
    <div class="profilehead">
      <div>
        <h1>{{ profile_user["username"] }}</h1>
        <p class="muted">
          Followers {{ followers_count }}
          Following {{ following_count }}
        </p>
      </div>

      {% if user and user["id"] != profile_user["id"] %}
        {% if is_following %}
          <form action="{{ url_for('unfollow', username=profile_user['username']) }}" method="post" class="inline">
            <button type="submit">Unfollow</button>
          </form>
        {% else %}
          <form action="{{ url_for('follow', username=profile_user['username']) }}" method="post" class="inline">
            <button type="submit">Follow</button>
          </form>
        {% endif %}
      {% endif %}
    </div>
  </section>

  <section class="list">
    {% for p in posts %}
      <article class="card post">
        <div class="postmeta">
          <a href="{{ url_for('profile', username=p['username']) }}">{{ p["username"] }}</a>
          <span class="muted">{{ p["created_at"] }}</span>
        </div>

        <p class="postbody">{{ p["content"] }}</p>

        <div class="actions">
          <span class="muted">
            <span class="likecount" data-id="{{ p['id'] }}">{{ p["like_count"] }}</span> likes Â·
            <span class="commentcount" data-id="{{ p['id'] }}">{{ p["comment_count"] }}</span> comments
          </span>

          {% if user %}
            <button
              type="button"
              class="likebtn"
              data-id="{{ p['id'] }}"
              data-liked="{{ p['liked_by_me'] }}"
            >
              {% if p["liked_by_me"] == 1 %}Unlike{% else %}Like{% endif %}
            </button>
          {% else %}
            <span class="muted">Log in to like</span>
          {% endif %}
        </div>

        {% set clist = comments_by_post.get(p["id"], []) %}
        <div class="comments" data-post-id="{{ p['id'] }}">
          {% for c in clist %}
            <div class="comment">
              <span class="commentuser">{{ c["username"] }}</span>
              <span class="muted">{{ c["created_at"] }}</span>
              <div class="commentbody">{{ c["content"] }}</div>
            </div>
          {% endfor %}

          {% if user %}
            <div class="commentform" data-id="{{ p['id'] }}">
              <input type="text" name="content" placeholder="Write a comment" required />
              <button type="button" class="commentpostbtn" data-id="{{ p['id'] }}">Post</button>
            </div>
          {% endif %}
        </div>
      </article>
    {% else %}
      <p class="muted">No posts yet.</p>
    {% endfor %}
  </section>

  <script>
    document.addEventListener("click", async (e) => {
      const likeBtn = e.target.closest(".likebtn");
      if (likeBtn) {
        e.preventDefault();

        const postId = likeBtn.dataset.id;
        const liked = likeBtn.dataset.liked === "1";

        try {
          const res = await fetch(`/api/posts/${postId}/like`, {
            method: liked ? "DELETE" : "POST",
          });

          let data = {};
          try {
            data = await res.json();
          } catch (_) {
            data = {};
          }

          if (res.status === 401) {
            alert("Please log in first.");
            return;
          }

          if (!res.ok) {
            alert(data.error || "Failed to update like.");
            return;
          }

          const likeSpan = document.querySelector(`.likecount[data-id="${postId}"]`);
          if (likeSpan && typeof data.like_count !== "undefined") {
            likeSpan.textContent = String(data.like_count);
          }

          if (typeof data.liked_by_me !== "undefined") {
            likeBtn.dataset.liked = String(data.liked_by_me);
            likeBtn.textContent = data.liked_by_me == 1 ? "Unlike" : "Like";
          } else {
            likeBtn.dataset.liked = liked ? "0" : "1";
            likeBtn.textContent = liked ? "Like" : "Unlike";
          }
        } catch (err) {
          console.error(err);
          alert("Network error.");
        }

        return;
      }

      const cbtn = e.target.closest(".commentpostbtn");
      if (!cbtn) return;

      e.preventDefault();

      const postId = cbtn.dataset.id;
      const box = document.querySelector(`.comments[data-post-id="${postId}"]`);
      if (!box) return;

      const formBox = box.querySelector(`.commentform[data-id="${postId}"]`);
      if (!formBox) return;

      const input = formBox.querySelector(`input[name="content"]`);
      const content = (input.value || "").trim();
      if (!content) return;

      cbtn.disabled = true;

      try {
        const res = await fetch(`/api/posts/${postId}/comments`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content }),
        });

        const data = await res.json();

        if (res.status === 401) {
          alert("Please log in first.");
          return;
        }

        if (!res.ok) {
          alert(data.error || "Failed to create comment.");
          return;
        }

        input.value = "";

        const wrap = document.createElement("div");
        wrap.className = "comment";
        wrap.innerHTML = `
          <span class="commentuser"></span>
          <span class="muted"></span>
          <div class="commentbody"></div>
        `;
        wrap.querySelector(".commentuser").textContent = data.comment.username;
        wrap.querySelector(".muted").textContent = data.comment.created_at;
        wrap.querySelector(".commentbody").textContent = data.comment.content;

        box.insertBefore(wrap, formBox);

        const cnt = document.querySelector(`.commentcount[data-id="${postId}"]`);
        if (cnt) cnt.textContent = String(data.comment_count);
      } catch (err) {
        console.error(err);
        alert("Network error.");
      } finally {
        cbtn.disabled = false;
      }
    });
  </script>
{% endblock %}
