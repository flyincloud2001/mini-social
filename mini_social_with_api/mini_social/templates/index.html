{% extends "layout.html" %}
{% set title = "Home" %}

{% block content %}
  <section class="card">
    <div class="feedhead">
      <h1>
        {% if feed == "following" %}
          Following Feed
        {% else %}
          Public Feed
        {% endif %}
      </h1>

      <div class="feedtabs">
        <a class="{% if feed != 'following' %}active{% endif %}" href="{{ url_for('index', feed='public') }}">Public</a>
        {% if user %}
          <a class="{% if feed == 'following' %}active{% endif %}" href="{{ url_for('index', feed='following') }}">Following</a>
        {% endif %}
      </div>
    </div>

    {% if feed == "following" %}
      <p class="muted">Only posts from people you follow, plus your own.</p>
    {% else %}
      <p class="muted">Everyone can see all posts.</p>
    {% endif %}

    {% if user %}
      <form action="{{ url_for('create_post') }}" method="post" class="postform" id="postform">
        <textarea name="content" rows="3" maxlength="500" placeholder="Write something"></textarea>
        <button type="submit">Post</button>
      </form>
    {% else %}
      <p class="muted">Log in to post, like, and comment.</p>
    {% endif %}
  </section>

  <!-- ðŸ”½ API è²¼æ–‡å®¹å™¨ -->
  <section class="list">
    <div id="posts"></div>
    <p class="muted" id="feed-empty" style="display:none;">No posts yet.</p>
  </section>

  <!-- ðŸ”½ API è¼‰å…¥è²¼æ–‡ -->
  <script>
    async function loadPosts() {
      const feed =
        new URLSearchParams(window.location.search).get("feed") || "public";

      const res = await fetch(`/api/posts?feed=${encodeURIComponent(feed)}`);
      const data = await res.json();

      const box = document.getElementById("posts");
      const empty = document.getElementById("feed-empty");
      box.innerHTML = "";

      if (!data.posts || data.posts.length === 0) {
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      for (const p of data.posts) {
        const el = document.createElement("article");
        el.className = "card post";

        el.innerHTML = `
          <div class="postmeta">
            <a href="/u/${p.username}">${p.username}</a>
            <span class="muted">${p.created_at}</span>
          </div>

          <p class="postbody"></p>

          <div class="actions">
            <span class="muted">
              ${p.like_count} likes Â· ${p.comment_count} comments
            </span>
          </div>
        `;

        el.querySelector(".postbody").innerText = p.content;
        box.appendChild(el);
      }
    }

    loadPosts();
    const form = document.getElementById("postform");
    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const textarea = form.querySelector("textarea[name='content']");
        const content = (textarea?.value || "").trim();
        if (!content) return;
  
        const res = await fetch("/api/posts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content }),
        });
  
        if (res.status === 401) {
          alert("Please log in first.");
          return;
        }
  
        const data = await res.json();
        if (!res.ok) {
          alert(data.error || "Failed to post.");
          return;
        }
  
        textarea.value = "";
        await loadPosts();
      });
    }
  </script>
{% endblock %}

