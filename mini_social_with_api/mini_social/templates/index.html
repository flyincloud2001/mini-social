{% extends "layout.html" %}
{% set title = "Home" %}

{% block content %}
  <section class="card">
    <div class="feedhead">
      <h1>
        {% if feed == "following" %}
          Following Feed
        {% else %}
          Public Feed
        {% endif %}
      </h1>

      <div class="feedtabs">
        <a class="{% if feed != 'following' %}active{% endif %}" href="{{ url_for('index', feed='public') }}">Public</a>
        {% if user %}
          <a class="{% if feed == 'following' %}active{% endif %}" href="{{ url_for('index', feed='following') }}">Following</a>
        {% endif %}
      </div>
    </div>

    {% if feed == "following" %}
      <p class="muted">Only posts from people you follow, plus your own.</p>
    {% else %}
      <p class="muted">Everyone can see all posts.</p>
    {% endif %}

    {% if user %}
        <textarea name="content" rows="3" maxlength="500" placeholder="Write something"></textarea>
        <button type="submit">Post</button>
      </form>
    {% else %}
      <p class="muted">Log in to post, like, and comment.</p>
    {% endif %}
  </section>

  <!-- ðŸ”½ API è²¼æ–‡å®¹å™¨ -->
  <section class="list">
    <div id="posts"></div>
    <p class="muted" id="feed-empty" style="display:none;">No posts yet.</p>
  </section>

  <!-- ðŸ”½ API è¼‰å…¥è²¼æ–‡ -->
<script>
  const IS_LOGGED_IN = {{ "true" if user else "false" }};

  async function loadPosts() {
    const feed = new URLSearchParams(window.location.search).get("feed") || "public";
    const res = await fetch(`/api/posts?feed=${encodeURIComponent(feed)}`);
    const data = await res.json();

    const box = document.getElementById("posts");
    const empty = document.getElementById("feed-empty");
    box.innerHTML = "";

    if (!data.posts || data.posts.length === 0) {
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    for (const p of data.posts) {
      const el = document.createElement("article");
      el.className = "card post";
      const commentsHtml = (p.comments || []).map(c => `
        <div class="comment">
          <span class="commentuser">${c.username}</span>
          <span class="muted">${c.created_at}</span>
          <div class="commentbody"></div>
        </div>
      `).join("");
      
      el.innerHTML = `
        <div class="postmeta">
          <a href="/u/${encodeURIComponent(p.username)}">${p.username}</a>
          <span class="muted">${p.created_at}</span>
        </div>
      
        <p class="postbody"></p>
      
        <div class="actions">
          <span class="muted">
            <span class="likecount" data-id="${p.id}">${p.like_count}</span> likes Â·
            <span class="commentcount" data-id="${p.id}">${p.comment_count}</span> comments
          </span>
      
          ${IS_LOGGED_IN ? `
            <button type="button" class="likebtn" data-id="${p.id}" data-liked="${p.liked_by_me}">
              ${p.liked_by_me ? "Unlike" : "Like"}
            </button>
          ` : ``}
        </div>
      
        <div class="comments" data-post-id="${p.id}">
          ${commentsHtml}
          ${IS_LOGGED_IN ? `
            <form class="commentform" data-id="${p.id}">
              <input type="text" name="content" placeholder="Write a comment" required />
              <button type="submit">Send</button>
            </form>
          ` : ``}
        </div>
      `;
      
      el.querySelector(".postbody").innerText = p.content;
      
      for (const [i, node] of Array.from(el.querySelectorAll(".commentbody")).entries()) {
        const c = (p.comments || [])[i];
        if (c) node.innerText = c.content;
      }

      el.querySelector(".postbody").innerText = p.content;
      box.appendChild(el);
    }
  }

  document.addEventListener("click", async (e) => {
    const btn = e.target.closest(".likebtn");
    if (!btn) return;
    e.preventDefault();
    if (!IS_LOGGED_IN) {
      alert("Please log in first.");
      return;
    }

    const postId = btn.getAttribute("data-id");
    const liked = btn.getAttribute("data-liked") === "1";

    const res = await fetch(`/api/posts/${postId}/like`, {
      method: liked ? "DELETE" : "POST",
    });

    const data = await res.json();

    if (res.status === 401) {
      alert("Please log in first.");
      return;
    }
    if (!res.ok) {
      alert(data.error || "Failed to update like.");
      return;
    }

    btn.setAttribute("data-liked", data.liked_by_me ? "1" : "0");
    btn.textContent = data.liked_by_me ? "Unlike" : "Like";

    const cnt = document.querySelector(`.likecount[data-id="${postId}"]`);
    if (cnt) cnt.textContent = String(data.like_count);
  });

  loadPosts();
  
  document.addEventListener("submit", async (e) => {
    const form = e.target.closest(".commentform");
    if (!form) return;
  
    e.preventDefault();
  
    const postId = form.dataset.id;
    const input = form.querySelector("input[name='content']");
    const content = (input.value || "").trim();
    if (!content) return;
  
    const res = await fetch(`/api/posts/${postId}/comments`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ content }),
    });
  
    const data = await res.json();
  
    if (res.status === 401) {
      alert("Please log in first.");
      return;
    }
    if (!res.ok) {
      alert(data.error || "Failed to create comment.");
      return;
    }
  
    input.value = "";
  
    const box = document.querySelector(`.comments[data-post-id="${postId}"]`);
    if (box) {
      const wrap = document.createElement("div");
      wrap.className = "comment";
      wrap.innerHTML = `
        <span class="commentuser">${data.comment.username}</span>
        <span class="muted">${data.comment.created_at}</span>
        <div class="commentbody"></div>
      `;
      wrap.querySelector(".commentbody").innerText = data.comment.content;
      box.insertBefore(wrap, form);
    }
  
    const cnt = document.querySelector(`.commentcount[data-id="${postId}"]`);
    if (cnt) cnt.textContent = String(data.comment_count);
  });

</script>

{% endblock %}






